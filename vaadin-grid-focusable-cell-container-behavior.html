<script>
  window.vaadin = window.vaadin || {};
  vaadin.elements = vaadin.elements || {};
  vaadin.elements.grid = vaadin.elements.grid || {};

  /**
   * @polymerBehavior vaadin.elements.grid.FocusableCellContainerBehavior
   */
  vaadin.elements.grid.FocusableCellContainerBehavior = {
    properties: {
      focused: {
        type: Boolean,
        reflectToAttribute: true
      },
      _focusedRow: Object,
      _focusedRowIndex: Number,
      _focusedCell: Object,
      _focusedCellIndex: Number
    },

    observers: ['_announceFocusedCell(_focusedCell, focused)', '_focusedCellChanged(_focusedRowIndex, _focusedCellIndex)'],

    _announceFocusedCell: function(cell, focused) {
      // changing activeTarget steals focus so we don't want to do that while interacting with
      // cell contents.
      // TODO: remember to change activeTarget when navigation mode is activated back.
      if (!this.domHost.navigating || !focused) {
        return;
      }
      // note: VoiceOver doesn't work with dynamic IDs.
      switch(this.is) {
        case 'vaadin-grid-table-header':
          this.domHost.$.headerFocusTrap.activeTarget = cell._cellContent.id;
          break;
        case 'vaadin-grid-table-body':
          var index = Polymer.dom(cell.parentElement).querySelectorAll('vaadin-grid-table-cell').indexOf(cell);
          var lastHeaderRow = this.domHost.$.header.lastElementChild;
          var headerCell = lastHeaderRow.children[index];

          // note: having `cell.column.name` property for announcing would maybe be a good option here?
          this.domHost.$.bodyFocusTrap.activeTarget = cell.hasAttribute('detailscell') ?
            cell._cellContent.id : headerCell._cellContent.id + ' ' + cell._cellContent.id;

          break;
        case 'vaadin-grid-table-footer':
          this.domHost.$.footerFocusTrap.activeTarget = cell._cellContent.id;
          break;
      }
    },

    _focusedCellChanged: function(rowIndex, cellIndex) {
      Polymer.dom(this).children.forEach(function(row, i) {
        row.focused = i === rowIndex;

        if (row.focused) {
          this._focusedRow = row;
          this._focusedCellIndex = Math.min(cellIndex, row.children.length - 1);
          this._focusedCell = row.children[this._focusedCellIndex];
        }

        row.cells.forEach(function(cell, j) {
          cell.focused = j === this._focusedCellIndex;
        }.bind(this));
      }.bind(this));
    },

    focusLeft: function() {
      if (this._focusedCell.hasAttribute('detailscell')) {
        return;
      }

      var visibleCells = this._visibleCellIndexes();
      if (visibleCells.length > 0) {
        var current = visibleCells.indexOf(this._focusedCellIndex);
        this._focusedCellIndex = visibleCells[Math.max(0, current - 1)];
      }
    },

    focusDown: function() {
      this._focusedRowIndex = Math.min(this._focusedRowIndex + 1, this.children.length - 1);
    },

    _visibleCellIndexes: function() {
      var indexes = [];
      if (this._focusedRow && this._focusedRow.children) {
        var children = this._focusedRow.children;
        for(var i = 0; i < children.length; i++) {
          if (!children[i].hidden && children[i] !== this._focusedRow._rowDetailsCell) {
            indexes.push(i);
          }
        }

        indexes.sort(function(i1, i2) {
          return children[i1].column._order < children[i2].column._order ? -1 : 1;
        });
      }

      return indexes;
    },

    focusPageDown: function() {
      this._focusedRowIndex = Math.min(this._focusedRowIndex + 10, this.children.length - 1);
    },

    focusPageUp: function() {
      this._focusedRowIndex = Math.max(0, this._focusedRowIndex - 10);
    },

    focusRight: function() {
      if (this._focusedCell.hasAttribute('detailscell')) {
        return;
      }

      var visibleCells = this._visibleCellIndexes();
      if (visibleCells.length > 0) {
        var current = visibleCells.indexOf(this._focusedCellIndex);
        this._focusedCellIndex = visibleCells[Math.min(current + 1, visibleCells.length - 1)];
      }
    },

    focusUp: function() {
      this._focusedRowIndex = Math.max(0, this._focusedRowIndex - 1);
    },

    focusHome: function() {
      if (this._focusedCell.hasAttribute('detailscell')) {
        return;
      }

      var visibleCells = this._visibleCellIndexes();
      if (visibleCells.length > 0) {
        this._focusedCellIndex = visibleCells[0];
      }
    },

    focusEnd: function() {
      if (this._focusedCell.hasAttribute('detailscell')) {
        return;
      }

      var visibleCells = this._visibleCellIndexes();
      if (visibleCells.length > 0) {
        this._focusedCellIndex = visibleCells[visibleCells.length - 1];
      }
    },

    focusFirst: function(e) {
      this._focusedRowIndex = 0;
      this.focusHome();
    },

    focusLast: function(e) {
      this._focusedRowIndex = this.children.length - 1;
      this.focusEnd();
    }
  };
</script>
