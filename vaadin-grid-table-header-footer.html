<script>
  (function() {
    var vaadinGridTableRowContainerBehavior = {
      properties: {
        columns: Array,
        frozenColumns: Number,
        _rows: Array
      },

      observers: ['_columnsChanged(columns, frozenColumns)', '_rowsChanged(_rows)'],

      _childColumns: function(columns) {
        return columns.map(function(col) {
          return col.childColumns || [col];
        }).reduce(function(prev, curr) {
          return prev.concat(curr);
        }, []);
      },

      _hasChildColumns: function(columns) {
        return columns.filter(function(col) {
          return col.childColumns;
        }).length > 0;
      },

      _columnsChanged: function(columns) {
        //TODO: should always be vaadin-grid. using domHost.domHost isn't
        // fully waterproof in case columns come via <content> elements.
        var target = this.domHost.domHost;

        var rows = [];

        do {
          var row = this._createRow();
          row.target = target;
          row._groupRow = this._hasChildColumns(columns);
          row.columns = columns;
          rows.push(row);
        } while (this._hasChildColumns(columns) && (columns = this._childColumns(columns)));

        rows[rows.length - 1].lastRow = true;
        this._rows = this.is === 'vaadin-grid-table-header' ? rows : rows.reverse();
      },

      _rowsChanged: function(rows) {
        Polymer.dom(this).innerHTML = '';

        rows.forEach(function(row) {
          Polymer.dom(this).appendChild(row);
        }.bind(this));
      }
    };

    Polymer({
      is: 'vaadin-grid-table-header',
      extends: 'thead',
      behaviors: [vaadinGridTableRowContainerBehavior],

      _createRow: function() {
        return document.createElement('tr', 'vaadin-grid-table-header-row');
      }
    });

    Polymer({
      is: 'vaadin-grid-table-footer',
      extends: 'tfoot',
      behaviors: [vaadinGridTableRowContainerBehavior],

      _createRow: function() {
        return document.createElement('tr', 'vaadin-grid-table-footer-row');
      }
    });
  })();
</script>
