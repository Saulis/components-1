<script>
  (function() {
    var vaadinGridTableRowContainerBehavior = {
      properties: {
        columns: Array,
        columnGroups: Array,
        frozenColumns: Number,
        _rows: Array
      },

      observers: ['_columnsChanged(columns.*, frozenColumns)', '_rowsChanged(_rows)', '_columnGroupsChanged(columnGroups.*)'],

      _columnGroupsChanged: function(e) {
        if (e.path.indexOf('columnGroups.#') === 0) {
          var groupIndex = parseInt(e.path.split('.')[1].substring(1));
          var group = this.columnGroups[groupIndex];
          this._rows.forEach(function(row) {
            var actualIndex = row.columns.indexOf(group);
            if (actualIndex > -1) {
              row.notifyPath(e.path.replace('columnGroups.#' + groupIndex, 'columns.#' + actualIndex), e.value);
            }
          });
        }
      },

      _childColumns: function(columns) {
        return columns.map(function(col) {
          if (col.is === 'vaadin-grid-column-group') {
            return Polymer.dom(col).children.filter(function(el) {
              return el.localName.indexOf('vaadin-grid-column') === 0;
            });
          } else {
            return [col];
          }
        }).reduce(function(prev, curr) {
          return prev.concat(curr);
        }, []);
      },

      _columnsChanged: function(e) {
        //TODO: footers not yet supported.
        if (this.is === 'vaadin-grid-table-footer') {
          return;
        }
        if (e.path === 'columns') {
          //TODO: should always be vaadin-grid. using domHost.domHost isn't
          // fully waterproof in case columns come via <content> elements.
          var target = this.domHost.domHost;

          //TODO: this calls for a property. it's missing multiselect etc.
          var columns = Polymer.dom(target).children.filter(function(el) {
            return el.localName.indexOf('vaadin-grid-column') === 0;
          });

          var hasChildren = function(cols) {
            return cols.filter(function(col) {
              return col.localName === 'vaadin-grid-column-group';
            }).length > 0;
          };

          var rows = [];

          var row = this._createRow();
          row.target = this.domHost.domHost;
          row.columns = columns;
          rows.push(row);

          while (hasChildren(columns)) {
            columns = this._childColumns(columns);

            var row = this._createRow();
            row.target = this.domHost.domHost;
            row.columns = columns;
            rows.push(row);
          }

          this._rows = rows;
        } else if (e.path.indexOf('columns.#') === 0) {
          var columnIndex = parseInt(e.path.split('.')[1].substring(1));
          var column = this.columns[columnIndex];
          this._rows.forEach(function(row) {
            var actualIndex = row.columns.indexOf(column);
            if (actualIndex > -1) {
              row.notifyPath(e.path.replace('.#' + columnIndex, '.#' + actualIndex), e.value);
            }
          });
        }
      },

      _rowsChanged: function(rows) {
        Polymer.dom(this).innerHTML = '';

        rows.forEach(function(row) {
          Polymer.dom(this).appendChild(row);
        }.bind(this));
      }
    };

    Polymer({
      is: 'vaadin-grid-table-header',
      extends: 'thead',
      behaviors: [vaadinGridTableRowContainerBehavior],

      _createRow: function() {
        return document.createElement('tr', 'vaadin-grid-table-header-row');
      }
    });

    Polymer({
      is: 'vaadin-grid-table-footer',
      extends: 'tfoot',
      behaviors: [vaadinGridTableRowContainerBehavior],

      _createRow: function() {
        return document.createElement('tr', 'vaadin-grid-table-footer-row');
      }
    });
  })();
</script>
