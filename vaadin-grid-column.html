<link rel="import" href="../polymer/polymer.html">

<dom-module id="vaadin-grid-column">
</dom-module>

<dom-module id="vaadin-grid-column-group">
</dom-module>

<script>
  (function() {

    var vaadinGridColumnBaseBehavior = {
      properties: {
        headerTemplate: {
          type: Object,
          value: function() {
            return this._findTemplate('template.header') || null;
          }
        },
        footerTemplate: {
          type: Object,
          value: function() {
            return this._findTemplate('template.footer') || null;
          }
        },
        instances: {
          type: Array,
          value: function() {
            return [];
          }
        },

        frozen: {
          type: Boolean,
          notify: true
        },

        _lastFrozen: {
          type: Boolean,
          notify: true
        }
      },

      observers: [
        '_footerTemplateChanged(footerTemplate)',
        '_headerTemplateChanged(headerTemplate)',
        '_lastFrozenChanged(_lastFrozen)'
      ],

      _selectFirstTemplate: function(selector) {
        return Polymer.dom(this).querySelectorAll(selector).filter(function(el) {
          return el.parentElement === this;
        }.bind(this))[0]
      },

      _findTemplate: function(selector) {
        var template = this._selectFirstTemplate(selector);
        if (template) {
          if (this.dataHost) {
            // set dataHost to the context where template has been defined
            template._rootDataHost = this.dataHost._rootDataHost || this.dataHost;
          }
        }
        return template;
      },

      _headerTemplateChanged: function(headerTemplate) {
        this.fire('property-changed', {path: 'headerTemplate', value: headerTemplate});
      },

      _footerTemplateChanged: function(footerTemplate) {
        this.fire('property-changed', {path: 'footerTemplate', value: footerTemplate});
      },

      _flexChanged: function(flex) {
        this.fire('property-changed', {path: 'flex', value: flex});
      },

      _widthChanged: function(width) {
        this.fire('property-changed', {path: 'width', value: width});
      },

      _lastFrozenChanged: function(lastFrozen) {
        this.fire('property-changed', {path: 'lastFrozen', value: lastFrozen});
      }
    };

    var vaadinGridColumnBehaviorImpl = {
      properties: {
        width: {
          type: String,
          value: '100px'
        },

        flex: {
          type: Number,
          value: 1
        },

        template: {
          type: Object,
          value: function() {
            return this._findTemplate('template:not(.header):not(.footer)');
          }
        },

        hidden: {
          type: Boolean
        },

        _forwardedParentProps: {
          value: function() {
            return {};
          }
        },

        _templateInstances: Array
      },

      observers: ['_flexChanged(flex)', '_widthChanged(width)', '_templateChanged(template)', '_frozenChanged(frozen)', '_hiddenChanged(hidden)',
                  '_forwardedParentPropsChanged(_forwardedParentProps.*, _templateInstances)'],

      created: function() {
        this._instanceProps = {
          expanded: true,
          index: true,
          item: true,
          selected: true
        };
      },

      _forwardInstanceProp: function(inst, prop, value) {
        // fire notification event only when a prop is changed through a user-action.
        // e.g. 'expanded' is different from the originally bound '__expanded__' value.
        if (inst['__' + prop + '__'] !== undefined &&
            inst['__' + prop + '__'] !== value) {
          this.fire('template-instance-changed', {
            prop: prop,
            value: value,
            inst: inst
          });
        }
      },

      _forwardInstancePath: function(inst, path, value) {
        // TODO: assuming we're currently just listening to [[item.xxxx]] properties
        // which affect only cells on the current row.
        if (path.indexOf('item.') === 0) {
          // this.parentElement.iterateCells(function(cell) {
          //   if (cell.instance) {
          //     cell.instance.notifyPath(path, value);
          //   }
          // });

          this.fire('item-changed', {
            item: inst.item,
            // stripping 'item.' from path.
            path: path.substring(5),
            value: value
          });

          // instance.notifyPath above will call _forwardInstancePath recursively,
          // so need to debounce to avoid firing the same event multiple times.
          // this.parentElement.debounce('item-changed', function() {
          // }.bind(this));
        }
      },

      _forwardParentProp: function(prop, value) {
        // _forwardParentProp might be called during this.stamp() before
        // this.instance is set. We need to delay it until instance is set.
        this.set('_forwardedParentProps.' + prop, value);
      },

      _forwardParentPath: function(path, value) {
        this.set('_forwardedParentProps.' + path, value);
      },

      _forwardedParentPropsChanged: function(e, templateInstances) {
        if (e.path !== '_forwardedParentProps') {
          var prop = e.path.substring(e.path.indexOf('.') + 1);
          var value = e.value;

          templateInstances.forEach(function(inst) {
            inst.notifyPath(prop, value);
          });
        }
      },

      _frozenChanged: function(frozen) {
        this.fire('property-changed', {path: 'frozen', value: frozen});
      },

      _templateChanged: function(template) {
        this._templateInstances = [];
        this.templatize(template);

        // TODO: hack to avoid: https://github.com/Polymer/polymer/issues/3307
        this._parentProps = this._parentProps || {};

        // We bubble false for optimisation
        this.fire('property-changed', {path: 'template', value: template}, {bubbles: false});
      },

      _hiddenChanged: function(hidden) {
        this.fire('property-changed', {path: 'hidden', value: hidden});
      }
    }

    window.vaadin = window.vaadin || {};
    vaadin.elements = vaadin.elements || {};
    vaadin.elements.grid = vaadin.elements.grid || {};
    /**
     * @polymerBehavior vaadin.elements.grid.vaadinGridColumnBehavior
     */
    vaadin.elements.grid.vaadinGridColumnBehavior = [
      vaadinGridColumnBaseBehavior,
      vaadinGridColumnBehaviorImpl
    ];

    Polymer({
      is: 'vaadin-grid-column',

      behaviors: [Polymer.Templatizer, vaadin.elements.grid.vaadinGridColumnBehavior]
    });

    Polymer({
      is: 'vaadin-grid-column-group',

      behaviors: [vaadinGridColumnBaseBehavior],

      properties: {
        _childColumns: {
          value: function() {
            return Polymer.dom(this).querySelectorAll('vaadin-grid-column, vaadin-grid-selection-column');
          }
        },

        flex: {
          type: Number,
          readOnly: true
        },

        width: {
          type: String,
          readOnly: true
        },

        _visibleChildColumns: Array,

        hidden: {
          type: Boolean,
          notify: true,
          readOnly: true
        },

        colSpan: {
          type: Number,
          notify: true,
          readOnly: true
        }
      },

      observers: ['_updateVisibleChildColumns(_childColumns)',
      '_childColumnsChanged(_childColumns)',
      '_flexChanged(flex)',
      '_widthChanged(width)',
      '_frozenChanged(_childColumns, frozen)',
      '_hiddenChanged(hidden)',
      '_visibleChildColumnsChanged(_visibleChildColumns)',
      '_colSpanChanged(colSpan)'],

      listeners: {
        'property-changed': '_columnPropChanged'
      },

      attached: function() {
        this._updateFlexAndWidth(this._visibleChildColumns);
        this._addNodeObserver();
      },

      detached: function() {
        Polymer.dom(this).unobserveNodes(this._observer);
      },

      _columnPropChanged: function(e) {
        if (e.detail.path === 'hidden') {
          this._updateVisibleChildColumns(this._childColumns);
        }

        if (/flex|width|hidden|_childColumns/.test(e.detail.path)) {
          this._updateFlexAndWidth(this._visibleChildColumns);
        }

        if (e.detail.path === 'frozen') {
          this.frozen = e.detail.value;
        }

        if (e.detail.path === 'lastFrozen') {
          this._lastFrozen = e.detail.value;
        }
      },

      _updateVisibleChildColumns: function(childColumns) {
        this._visibleChildColumns = childColumns.filter(function(col) {
          return !col.hidden;
        });
      },

      _childColumnsChanged: function(childColumns) {
        this.fire('property-changed', {path: '_childColumns', value: childColumns});
      },

      _updateFlexAndWidth: function(visibleChildColumns) {
        this._setWidth('calc(' + visibleChildColumns.reduce(function(prev, curr) {
          return prev += ' + ' + (curr.width || '0').replace('calc', '');
        }, '').substring(3) + ')');

        this._setFlex(visibleChildColumns.reduce(function(prev, curr) {
          return prev + curr.flex;
        }, 0));
      },

      _frozenChanged: function(childColumns, frozen) {
        childColumns.forEach(function(col) {
          col.frozen = frozen;
        });
        this.fire('property-changed', {path: 'frozen', value: frozen});
      },

      _hiddenChanged: function(hidden) {
        this.fire('property-changed', {path: 'hidden', value: hidden});
      },

      _visibleChildColumnsChanged: function(visibleChildColumns) {
        this._setColSpan(visibleChildColumns.length);
        this._setHidden(this.colSpan === 0);
      },

      _colSpanChanged: function(colSpan) {
        this.fire('property-changed', {path: 'colSpan', value: colSpan});
      },

      _addNodeObserver: function() {
        this._observer = Polymer.dom(this).observeNodes(function(info) {
          var columns = function(node) {
            return (node.nodeType === Node.ELEMENT_NODE && node.localName.indexOf('vaadin-grid-column') === 0);
          };
          if (info.addedNodes.filter(columns).length > 0 ||
          info.removedNodes.filter(columns).length > 0) {
            this._childColumns = Polymer.dom(this).querySelectorAll('vaadin-grid-column');
          }
        }.bind(this));
      }
    });

  }());

</script>
