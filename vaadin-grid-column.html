<link rel="import" href="../polymer/polymer.html">

<dom-module id="vaadin-grid-column">
  <template>
    <style>
      :host {
        display: none;
      }
    </style>
  </template>
</dom-module>
<dom-module id="vaadin-grid-column-group">
  <template>
    <style>
      :host {
        display: none;
      }
    </style>
  </template>
</dom-module>

<script>
  (function() {
    var vaadinGridColumnBehavior = {
      properties: {
        instances: {
          type: Array,
          value: function() {
            return [];
          }
        },
        name: {
          type: String,
          value: ''
        },
        template: {
          type: Object,
          notify: true,
          value: function() {
            return this._templates()[0];
          }
        },
        grid: Object
      },

      _templates: function(type) {
        return Polymer.dom(this).children.filter(function(t) {
          return t.tagName.toLowerCase() == 'template' && t.getAttribute('is') == type;
        }).map(function(t) {
          if (this.dataHost) {
            // set dataHost to the context where template has been defined
            t._rootDataHost = this.dataHost._rootDataHost || this.dataHost;
          }
          return t;
        }.bind(this));
      },

      _group: function() {
        var node = Polymer.dom(this).parentNode;
        return node && node.is == 'vaadin-grid-column-group' ? node : null;
      },

      _rowCount: function(type) {
        if (type) {
          var ret = this._templates(type).length;
          ret += Math.max.apply(Math, Polymer.dom(this).children.map(function(c) {
            return c._rowCount && c._rowCount(type) || 0;
          }));
          return !ret && this.is == 'vaadin-grid-column' ? 1 : ret;
        }
      },

      _colCount: function() {
        return this._columns().length;
      }
    };

    Polymer({
      is: 'vaadin-grid-column',

      behaviors: [vaadinGridColumnBehavior],

      properties: {
        width: {
          type: String,
          value: '100px',
          notify: true
        },

        flex: {
          type: Number,
          value: 1,
          notify: true
        }
      },

      observers: [
        '_flexChanged(grid, flex)',
        '_widthChanged(grid, width)'
      ],

      _columns: function() {
        return [this];
      },

      _flexChanged: function(grid, flex) {
        var index = grid._columns.indexOf(this);
        grid.notifyPath('_columns.' + index + '.flex', flex);
      },

      _widthChanged: function(grid, width) {
        var index = grid._columns.indexOf(this);
        grid.notifyPath('_columns.' + index + '.width', width);
      },

      _colWidth: function() {
        return this.width || '100px';
      },

      _colFlex: function() {
        return this.flex || 1;
      }
    });

    Polymer({
      is: 'vaadin-grid-column-group',

      behaviors: [vaadinGridColumnBehavior],

      _columns: function() {
        var r = Polymer.dom(this).querySelectorAll('vaadin-grid-column');
        return r.length ? r : [this];
      },

      _colWidth: function() {
        return this._columns().map(function(c) {
          return c.width || c.getAttribute('width') || '100px';
        }).join(' + ') || '0px';
      },

      _colFlex: function() {
        return 1;
      }

    });
  })();
</script>
