<link rel="import" href="../polymer/polymer.html">

<dom-module id="vaadin-grid-column">
  <template>
    <style>
      :host {
        display: none;
      }
    </style>
  </template>
  <script>
    Polymer({
      is: 'vaadin-grid-column',

      properties: {
        headers: {
          type: Array,
          notify: true,
          value: function() {
            var headerTemplates = Polymer.dom(this).querySelectorAll('template[is=header]');
            if (headerTemplates) {
              return headerTemplates.map(function(t) {
                var colspan = t.hasAttribute('colspan') && parseInt(t.getAttribute('colspan')) || 0;

                if (this.dataHost) {
                  // set dataHost to the context where template has been defined
                  t._rootDataHost = this.dataHost._rootDataHost || this.dataHost;
                }

                return { template: t, colspan: colspan };
              }.bind(this));
            } else {
              return [];
            }
          }
        },
        footers: {
          type: Array,
          notify: true,
          value: function() {
            var headerTemplates = Polymer.dom(this).querySelectorAll('template[is=footer]');
            if (headerTemplates) {
              return headerTemplates.map(function(t) {
                var colspan = t.hasAttribute('colspan') && parseInt(t.getAttribute('colspan')) || 0;

                if (this.dataHost) {
                  // set dataHost to the context where template has been defined
                  t._rootDataHost = this.dataHost._rootDataHost || this.dataHost;
                }

                return { template: t, colspan: colspan };
              }.bind(this));
            } else {
              return [];
            }
          }
        },
        instances: {
          type: Array,
          value: function() {
            return [];
          }
        },
        name: {
          type: String,
          value: ''
        },
        template: {
          type: Object,
          notify: true,
          value: function() {
            var template = Polymer.dom(this).querySelector('template:not([is=header])');
            if (this.dataHost) {
              // set dataHost to the context where template has been defined
              template._rootDataHost = this.dataHost._rootDataHost || this.dataHost;
            }
            return template;
          }
        },
        width: {
          type: String,
          value: '100px'
        },

        flex: {
          type: Number,
          value: 1
        },

        filterBy: String,
        filterValue: String,

        /**
         * Reference to the parent <vaadin-grid> element
         */
        grid: Object
      },

      observers: ['_flexChanged(grid, flex)', '_widthChanged(grid, width)', '_filtersChanged(grid, filterBy, filterValue)'],

      ready: function() {
        // when using Polymer bindings, default values trickle down using observers.
        // we're not using bindings between columns and cells so we need to use
        // and fire notifications manually.
        this.fire('headers-changed', {value: this.headers});
        this.fire('footers-changed', {value: this.footers});
      },

      _indexOf: function(grid) {
        return grid.columns.indexOf(this);
      },

      _flexChanged: function(grid, flex) {
        var index = this._indexOf(grid);
        grid.notifyPath('columns.' + index + '.flex', flex);
      },

      // for no reason in particular, only notify when both filterBy and filterValue are set.
      _filtersChanged: function(grid, filterBy, filterValue) {
        var index = this._indexOf(grid);
        grid.notifyPath('columns.' + index + '.filterBy', filterBy);
        grid.notifyPath('columns.' + index + '.filterValue', filterValue);
      },

      _widthChanged: function(grid, width) {
        var index = this._indexOf(grid);
        grid.notifyPath('columns.' + index + '.width', width);
      }
    });
  </script>
</dom-module>
